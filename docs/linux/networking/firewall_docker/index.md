# Расширенный справочник UFW + Docker на Debian

---

## 1. Основная идея

- Docker создаёт собственные сети для контейнеров, но по умолчанию трафик на порты пробрасывается на хост.  
- UFW может контролировать доступ к портам Docker, но для корректной работы рекомендуется настроить политику `DOCKER-USER`.

---

## 2. Разрешение трафика для контейнеров

### Пример: веб-приложение на порту 5000

```bash
sudo ufw allow 5000/tcp
```

| Команда | Назначение |
|---------|------------|
| ufw allow 5000/tcp | Разрешает доступ к порту контейнера снаружи хоста |

---

## 3. Ограничение доступа по IP к контейнеру

```bash
sudo ufw allow from 192.168.1.50 to any port 5000 proto tcp
```

| Команда | Назначение |
|---------|------------|
| ufw allow from IP to any port PORT proto tcp | Разрешает подключение к порту только с указанного IP |

---

## 4. Применение правил через цепочку DOCKER-USER

Docker добавляет iptables-правила, но можно создать пользовательскую цепочку для дополнительного контроля:

```bash
sudo ufw insert 1 allow from 192.168.1.0/24 to any port 5000 proto tcp comment 'Allow internal network'
sudo ufw insert 2 deny from any to any port 5000 proto tcp comment 'Block external access'
```

| Команда | Назначение |
|---------|------------|
| ufw insert NUM RULE | Вставляет правило на позицию NUM для контейнера или порта |
| comment '...' | Добавляет комментарий для удобства управления правилами |

---

## 5. Настройка проброса портов Docker с контролем UFW

При запуске контейнера с пробросом порта:

```bash
docker run -d -p 5000:5000 --name my_app my_image
```

- UFW должен разрешить порт 5000 (см. выше).  
- Без разрешения порт будет недоступен снаружи.

---

## 6. Ограничение доступа к Docker API

Если Docker API слушает TCP (например, для удалённого управления):

```bash
sudo ufw deny 2375/tcp
sudo ufw allow from 192.168.1.100 to any port 2375 proto tcp
```

| Команда | Назначение |
|---------|------------|
| deny 2375/tcp | Блокирует открытый Docker API |
| allow from IP to port 2375 | Разрешает доступ только с доверенного IP |

---

## 7. Контроль трафика между контейнерами

- По умолчанию Docker internal networks изолированы, но можно разрешать только нужные IP через правила DOCKER-USER.  

```bash
sudo ufw route allow proto tcp from 172.18.0.0/16 to 172.18.0.0/16 port 3306
```

| Команда | Назначение |
|---------|------------|
| ufw route allow | Разрешает маршрутизируемый трафик между подсетями Docker |
| from/to | Определяет исходный и целевой диапазон IP |

---

## 8. Логирование трафика Docker

```bash
sudo ufw logging on
sudo ufw logging high
```

| Команда | Назначение |
|---------|------------|
| ufw logging on | Включение логирования активности на всех Docker-портах |
| ufw logging high | Детализированное логирование попыток доступа к контейнерам |

---

## 9. Советы безопасности для Docker + UFW

- Всегда блокируйте все внешние порты, кроме тех, что нужны для сервисов.  
- Разделяйте внутренние сети Docker и внешний доступ с помощью правил UFW.  
- Используйте цепочку DOCKER-USER для контроля доступа, чтобы новые контейнеры не обходили правила.  
- Логи UFW позволяют отслеживать несанкционированный доступ к контейнерам.  
- Ограничивайте доступ к Docker API только доверенным IP.  
- Применяйте строгую политику для контейнеров с базами данных, открывая порты только внутренней сети.

---

## 10. Полезные комбинации команд для Docker + UFW

| Действие | Команда |
|-----------|---------|
| Разрешить доступ к порту контейнера только с конкретного IP | `sudo ufw allow from IP to any port PORT proto tcp` |
| Заблокировать доступ к порту контейнера для всех | `sudo ufw deny PORT/tcp` |
| Разрешить внутренний трафик между контейнерами | `sudo ufw route allow proto tcp from SUBNET1 to SUBNET2 port PORT` |
| Включить логирование активности контейнеров | `sudo ufw logging high` |
| Проверить состояние правил | `sudo ufw status numbered` |

